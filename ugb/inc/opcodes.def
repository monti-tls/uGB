/***********************************************/
/*** Modified Z80 instruction set definition ***/
/***********************************************/

// http://www.devrs.com/gb/files/opcodes.html

#ifndef DEF_OPCODE
#define DEF_OPCODE(prefix, opcode, size, cycles, flags, mnemonic, microcode)
#endif

#define TODO

DEF_OPCODE(, 00, 1, 4,  "____", "NOP",          ;                             )
DEF_OPCODE(, 01, 3, 12, "____", "LD BC, d16",   BC = d16;                     )
DEF_OPCODE(, 02, 1, 8,  "____", "LD (BC), A",   w(BC, A);                     )
DEF_OPCODE(, 03, 1, 8,  "____", "INC BC",       ++BC;                         )
DEF_OPCODE(, 04, 1, 4,  "Z0H_", "INC B",        _H3(B, ++B); _Z(B);           )
DEF_OPCODE(, 05, 1, 4,  "Z1H_", "DEC B",        _H3(B, --B); _Z(B);           )
DEF_OPCODE(, 06, 2, 8,  "____", "LD B, d8",     B = d8;                       )
DEF_OPCODE(, 07, 1, 4,  "000C", "RLCA",         _Cs(A & 0x80); A = rol8(A);   )
DEF_OPCODE(, 08, 3, 20, "____", "LD (a16), SP", w(a16, SPl); w(a16+1, SPh);   )
DEF_OPCODE(, 09, 1, 8,  "_0HC", "ADD HL, BC",   _C15H11(HL, HL = HL + BC);    )
DEF_OPCODE(, 0A, 1, 8,  "____", "LD A, (BC)",   r(BC, &A);                    )
DEF_OPCODE(, 0B, 1, 8,  "____", "DEC BC",       --BC;                         )
DEF_OPCODE(, 0C, 1, 4,  "Z0H_", "INC C",        _H3(C, ++C); _Z(C);           )
DEF_OPCODE(, 0D, 1, 4,  "Z1H_", "DEC C",        _H3(C, --C); _Z(C);           )
DEF_OPCODE(, 0E, 2, 8,  "____", "LD C, d8",     C = d8;                       )
DEF_OPCODE(, 0F, 1, 4,  "000C", "RRCA",         _Cs(A & 0x01); A = ror8(A);   )

DEF_OPCODE(, 10, 2, 4,  "____", "STOP 0",       TODO;                         )
DEF_OPCODE(, 11, 3, 12, "____", "LD DE, d16",   DE = d16;                     )
DEF_OPCODE(, 12, 1, 8,  "____", "LD (DE), A",   w(DE, A);                     )
DEF_OPCODE(, 13, 1, 8,  "____", "INC DE",       ++DE;                         )
DEF_OPCODE(, 14, 1, 4,  "Z0H_", "INC D",        _H3(D, ++D); _Z(D);           )
DEF_OPCODE(, 15, 1, 4,  "Z1H_", "DEC D",        _H3(D, --D); _Z(D);           )
DEF_OPCODE(, 16, 2, 8,  "____", "LD D, d8",     D = d8;                       )
DEF_OPCODE(, 17, 1, 4,  "000C", "RLA",          t8 = _fC; _Cs(A & 0x80); \
                                                A = (A << 1) | t8;            )
DEF_OPCODE(, 18, 2, 12, "____", "JR PCr8",      PC += r8;                     )
DEF_OPCODE(, 19, 1, 8,  "_0HC", "ADD HL, DE",   _C15H11(HL, HL = HL + DE);    )
DEF_OPCODE(, 1A, 1, 8,  "____", "LD A, (DE)",   r(DE, &A);                    )
DEF_OPCODE(, 1B, 1, 8,  "____", "DEC DE",       --DE;                         )
DEF_OPCODE(, 1C, 1, 4,  "Z0H_", "INC E",        _H3(E, ++E); _Z(E);           )
DEF_OPCODE(, 1D, 1, 4,  "Z1H_", "DEC E",        _H3(E, --E); _Z(E);           )
DEF_OPCODE(, 1E, 2, 8,  "____", "LD E, PCd8",   E = d8;                       )
DEF_OPCODE(, 1F, 1, 4,  "000C", "RRA",          t8 = _fC; _Cs(A & 0x01); \
                                                A = (A >> 1) | (t8 << 7);     )

DEF_OPCODE(, 20, 2, 8,  "____", "JR NZ, PCr8",  _NIF(_fZ, PC += r8;, 4);      )
DEF_OPCODE(, 21, 3, 12, "____", "LD HL, d16",   HL = d16;                     )
DEF_OPCODE(, 22, 1, 8,  "____", "LD (HL+), A",  w(HL++, A);                   )
DEF_OPCODE(, 23, 1, 8,  "____", "INC HL",       ++HL;                         )
DEF_OPCODE(, 24, 1, 4,  "Z0H_", "INC H",        _H3(H, ++H); _Z(H);           )
DEF_OPCODE(, 25, 1, 4,  "Z1H_", "DEC H",        _H3(H, --H); _Z(H);           )
DEF_OPCODE(, 26, 2, 8,  "____", "LD H, d8",     H = d8;                       )
DEF_OPCODE(, 27, 1, 4,  "Z_0C", "DAA",          TODO;                         )
DEF_OPCODE(, 28, 2, 8,  "____", "JR Z, PCr8",   _IF(_fZ, PC += r8, 4);        )
DEF_OPCODE(, 29, 1, 8,  "_0HC", "ADD HL, HL",   _C15H11(HL, HL = HL + HL);    )
DEF_OPCODE(, 2A, 1, 8,  "____", "LD A, (HL+)",  r(HL++, &A);                  )
DEF_OPCODE(, 2B, 1, 8,  "____", "DEC HL",       --HL;                         )
DEF_OPCODE(, 2C, 1, 4,  "Z0H_", "INC L",        _H3(L, ++L); _Z(L);           )
DEF_OPCODE(, 2D, 1, 4,  "Z1H_", "DEC L",        _H3(L, --L); _Z(L);           )
DEF_OPCODE(, 2E, 2, 8,  "____", "LD L, d8",     L = d8;                       )
DEF_OPCODE(, 2F, 1, 4,  "_11_", "CPL",          A = ~A;                       )

DEF_OPCODE(, 30, 2, 8,  "____", "JR NC, PCr8",  _NIF(_fC, PC += r8;, 4);      )
DEF_OPCODE(, 31, 3, 12, "____", "LD SP, d16",   SP = d16;                     )
DEF_OPCODE(, 32, 1, 8,  "____", "LD (HL-), A",  w(HL--, A);                   )
DEF_OPCODE(, 33, 1, 8,  "____", "INC SP",       ++SP;                         )
DEF_OPCODE(, 34, 1, 12, "Z0H_", "INC (HL)",     r(HL, &t8); _H3(t8, ++t8); \
                                                _Z(t8); w(HL, t8);            )
DEF_OPCODE(, 35, 1, 12, "Z1H_", "DEC (HL)",     r(HL, &t8); _H3(t8, --t8); \
                                                _Z(t8); w(HL, t8);            )
DEF_OPCODE(, 36, 2, 12, "____", "LD (HL), d8",  w(HL, d8);                    )
DEF_OPCODE(, 37, 1, 4,  "_001", "SCF",                                        )
DEF_OPCODE(, 38, 2, 8,  "____", "JR C, PCr8",   _IF(_fC, PC += r8, 4);        )
DEF_OPCODE(, 39, 1, 8,  "_0HC", "ADD HL, SP",   _C15H11(HL, HL = HL + SP);    )
DEF_OPCODE(, 3A, 1, 8,  "____", "LD A, (HL-)",  r(HL--, &A);                  )
DEF_OPCODE(, 3B, 1, 8,  "____", "DEC SP",       --SP;                         )
DEF_OPCODE(, 3C, 1, 4,  "Z0H_", "INC A",        _H3(A, ++A); _Z(A);           )
DEF_OPCODE(, 3D, 1, 4,  "Z1H_", "DEC A",        _H3(A, --A); _Z(A);           )
DEF_OPCODE(, 3E, 2, 8,  "____", "LD A, d8",     A = d8;                       )
DEF_OPCODE(, 3F, 1, 4,  "_00C", "CCF",          _Cs(!_fC);                    )

DEF_OPCODE(, 40, 1, 4,  "____", "LD B, B",      B = B;                        )
DEF_OPCODE(, 41, 1, 4,  "____", "LD B, C",      B = C;                        )
DEF_OPCODE(, 42, 1, 4,  "____", "LD B, D",      B = D;                        )
DEF_OPCODE(, 43, 1, 4,  "____", "LD B, E",      B = E;                        )
DEF_OPCODE(, 44, 1, 4,  "____", "LD B, H",      B = H;                        )
DEF_OPCODE(, 45, 1, 4,  "____", "LD B, L",      B = L;                        )
DEF_OPCODE(, 46, 1, 8,  "____", "LD B, (HL)",   r(HL, &B);                    )
DEF_OPCODE(, 47, 1, 4,  "____", "LD B, A",      B = A;                        )
DEF_OPCODE(, 48, 1, 4,  "____", "LD C, B",      C = B;                        )
DEF_OPCODE(, 49, 1, 4,  "____", "LD C, C",      C = C;                        )
DEF_OPCODE(, 4A, 1, 4,  "____", "LD C, D",      C = D;                        )
DEF_OPCODE(, 4B, 1, 4,  "____", "LD C, E",      C = E;                        )
DEF_OPCODE(, 4C, 1, 4,  "____", "LD C, H",      C = H;                        )
DEF_OPCODE(, 4D, 1, 4,  "____", "LD C, L",      C = L;                        )
DEF_OPCODE(, 4E, 1, 8,  "____", "LD C, (HL)",   r(HL, &C);                    )
DEF_OPCODE(, 4F, 1, 4,  "____", "LD C, A",      C = A;                        )

DEF_OPCODE(, 50, 1, 4,  "____", "LD D, B",      D = B;                        )
DEF_OPCODE(, 51, 1, 4,  "____", "LD D, C",      D = C;                        )
DEF_OPCODE(, 52, 1, 4,  "____", "LD D, D",      D = D;                        )
DEF_OPCODE(, 53, 1, 4,  "____", "LD D, E",      D = E;                        )
DEF_OPCODE(, 54, 1, 4,  "____", "LD D, H",      D = H;                        )
DEF_OPCODE(, 55, 1, 4,  "____", "LD D, L",      D = L;                        )
DEF_OPCODE(, 56, 1, 8,  "____", "LD D, (HL)",   r(HL, &D);                    )
DEF_OPCODE(, 57, 1, 4,  "____", "LD D, A",      D = A;                        )
DEF_OPCODE(, 58, 1, 4,  "____", "LD E, B",      E = B;                        )
DEF_OPCODE(, 59, 1, 4,  "____", "LD E, C",      E = C;                        )
DEF_OPCODE(, 5A, 1, 4,  "____", "LD E, D",      E = D;                        )
DEF_OPCODE(, 5B, 1, 4,  "____", "LD E, E",      E = E;                        )
DEF_OPCODE(, 5C, 1, 4,  "____", "LD E, H",      E = H;                        )
DEF_OPCODE(, 5D, 1, 4,  "____", "LD E, L",      E = L;                        )
DEF_OPCODE(, 5E, 1, 8,  "____", "LD E, (HL)",   r(HL, &E);                    )
DEF_OPCODE(, 5F, 1, 4,  "____", "LD E, A",      E = A;                        )

DEF_OPCODE(, 60, 1, 4,  "____", "LD H, B",      H = B;                        )
DEF_OPCODE(, 61, 1, 4,  "____", "LD H, C",      H = C;                        )
DEF_OPCODE(, 62, 1, 4,  "____", "LD H, D",      H = D;                        )
DEF_OPCODE(, 63, 1, 4,  "____", "LD H, E",      H = E;                        )
DEF_OPCODE(, 64, 1, 4,  "____", "LD H, H",      H = H;                        )
DEF_OPCODE(, 65, 1, 4,  "____", "LD H, L",      H = L;                        )
DEF_OPCODE(, 66, 1, 8,  "____", "LD H, (HL)",   r(HL, &H);                    )
DEF_OPCODE(, 67, 1, 4,  "____", "LD H, A",      H = A;                        )
DEF_OPCODE(, 68, 1, 4,  "____", "LD L, B",      L = B;                        )
DEF_OPCODE(, 69, 1, 4,  "____", "LD L, C",      L = C;                        )
DEF_OPCODE(, 6A, 1, 4,  "____", "LD L, D",      L = D;                        )
DEF_OPCODE(, 6B, 1, 4,  "____", "LD L, E",      L = E;                        )
DEF_OPCODE(, 6C, 1, 4,  "____", "LD L, H",      L = H;                        )
DEF_OPCODE(, 6D, 1, 4,  "____", "LD L, L",      L = L;                        )
DEF_OPCODE(, 6E, 1, 8,  "____", "LD L, (HL)",   r(HL, &L);                    )
DEF_OPCODE(, 6F, 1, 4,  "____", "LD L, A",      L = A;                        )

DEF_OPCODE(, 70, 1, 8,  "____", "LD (HL), B",   w(HL, B);                     )
DEF_OPCODE(, 71, 1, 8,  "____", "LD (HL), C",   w(HL, C);                     )
DEF_OPCODE(, 72, 1, 8,  "____", "LD (HL), D",   w(HL, D);                     )
DEF_OPCODE(, 73, 1, 8,  "____", "LD (HL), E",   w(HL, E);                     )
DEF_OPCODE(, 74, 1, 8,  "____", "LD (HL), H",   w(HL, H);                     )
DEF_OPCODE(, 75, 1, 8,  "____", "LD (HL), L",   w(HL, L);                     )
DEF_OPCODE(, 76, 1, 4,  "____", "HALT",         TODO;                         )
DEF_OPCODE(, 77, 1, 8,  "____", "LD (HL), A",   w(HL, A);                     )
DEF_OPCODE(, 78, 1, 4,  "____", "LD A, B",      A = B;                        )
DEF_OPCODE(, 79, 1, 4,  "____", "LD A, C",      A = C;                        )
DEF_OPCODE(, 7A, 1, 4,  "____", "LD A, D",      A = D;                        )
DEF_OPCODE(, 7B, 1, 4,  "____", "LD A, E",      A = E;                        )
DEF_OPCODE(, 7C, 1, 4,  "____", "LD A, H",      A = H;                        )
DEF_OPCODE(, 7D, 1, 4,  "____", "LD A, L",      A = L;                        )
DEF_OPCODE(, 7E, 1, 4,  "____", "LD A, (HL)",   r(HL, &A);                    )
DEF_OPCODE(, 7F, 1, 8,  "____", "LD A, A",      A = A;                        )

#define _ADD(expr) _C15H11(A, A += (expr)); _Z(A);
#define _ADC(expr) _C15H11(A, A += ((expr) + _fC)); _Z(A);

DEF_OPCODE(, 80, 1, 4,  "Z0HC", "ADD A, B",     _ADD(B);                      )
DEF_OPCODE(, 81, 1, 4,  "Z0HC", "ADD A, C",     _ADD(C);                      )
DEF_OPCODE(, 82, 1, 4,  "Z0HC", "ADD A, D",     _ADD(D);                      )
DEF_OPCODE(, 83, 1, 4,  "Z0HC", "ADD A, E",     _ADD(E);                      )
DEF_OPCODE(, 84, 1, 4,  "Z0HC", "ADD A, H",     _ADD(H);                      )
DEF_OPCODE(, 85, 1, 4,  "Z0HC", "ADD A, L",     _ADD(L);                      )
DEF_OPCODE(, 86, 1, 8,  "Z0HC", "ADD A, (HL)",  r(HL, &t8); _ADD(t8);         )
DEF_OPCODE(, 87, 1, 4,  "Z0HC", "ADD A, A",     _ADD(A);                      )
DEF_OPCODE(, 88, 1, 4,  "Z0HC", "ADC A, B",     _ADC(B);                      )
DEF_OPCODE(, 89, 1, 4,  "Z0HC", "ADC A, C",     _ADC(C);                      )
DEF_OPCODE(, 8A, 1, 4,  "Z0HC", "ADC A, D",     _ADC(D);                      )
DEF_OPCODE(, 8B, 1, 4,  "Z0HC", "ADC A, E",     _ADC(E);                      )
DEF_OPCODE(, 8C, 1, 4,  "Z0HC", "ADC A, H",     _ADC(H);                      )
DEF_OPCODE(, 8D, 1, 4,  "Z0HC", "ADC A, L",     _ADC(L);                      )
DEF_OPCODE(, 8E, 1, 8,  "Z0HC", "ADC A, (HL)",  r(HL, &t8); _ADC(t8);         )
DEF_OPCODE(, 8F, 1, 4,  "Z0HC", "ADC A, A",     _ADC(A);                      )

#define _SUB(expr) _C15H11(A, A -= (expr)); _Z(A);
#define _SBC(expr) _C15H11(A, A -= ((expr) + _fC)); _Z(A);

DEF_OPCODE(, 90, 1, 4,  "Z1HC", "SUB B",        _SUB(B);                      )
DEF_OPCODE(, 91, 1, 4,  "Z1HC", "SUB C",        _SUB(C);                      )
DEF_OPCODE(, 92, 1, 4,  "Z1HC", "SUB D",        _SUB(D);                      )
DEF_OPCODE(, 93, 1, 4,  "Z1HC", "SUB E",        _SUB(E);                      )
DEF_OPCODE(, 94, 1, 4,  "Z1HC", "SUB H",        _SUB(H);                      )
DEF_OPCODE(, 95, 1, 4,  "Z1HC", "SUB L",        _SUB(L);                      )
DEF_OPCODE(, 96, 1, 8,  "Z1HC", "SUB (HL)",     r(HL, &t8); _SUB(t8);         )
DEF_OPCODE(, 97, 1, 4,  "Z1HC", "SUB A",        _SUB(A);                      )
DEF_OPCODE(, 98, 1, 4,  "Z1HC", "SBC B",        _SBC(B);                      )
DEF_OPCODE(, 99, 1, 4,  "Z1HC", "SBC C",        _SBC(C);                      )
DEF_OPCODE(, 9A, 1, 4,  "Z1HC", "SBC D",        _SBC(D);                      )
DEF_OPCODE(, 9B, 1, 4,  "Z1HC", "SBC E",        _SBC(E);                      )
DEF_OPCODE(, 9C, 1, 4,  "Z1HC", "SBC H",        _SBC(H);                      )
DEF_OPCODE(, 9D, 1, 4,  "Z1HC", "SBC L",        _SBC(L);                      )
DEF_OPCODE(, 9E, 1, 8,  "Z1HC", "SBC (HL)",     r(HL, &t8); _SBC(t8);         )
DEF_OPCODE(, 9F, 1, 4,  "Z1HC", "SBC A",        _SBC(A);                      )

DEF_OPCODE(, A0, 1, 4,  "Z010", "AND B",        A &= B; _Z(A);                )
DEF_OPCODE(, A1, 1, 4,  "Z010", "AND C",        A &= C; _Z(A);                )
DEF_OPCODE(, A2, 1, 4,  "Z010", "AND D",        A &= D; _Z(A);                )
DEF_OPCODE(, A3, 1, 4,  "Z010", "AND E",        A &= E; _Z(A);                )
DEF_OPCODE(, A4, 1, 4,  "Z010", "AND H",        A &= H; _Z(A);                )
DEF_OPCODE(, A5, 1, 4,  "Z010", "AND L",        A &= L; _Z(A);                )
DEF_OPCODE(, A6, 1, 8,  "Z010", "AND (HL)",     r(HL, &t8); A &= t8; _Z(A);   )
DEF_OPCODE(, A7, 1, 4,  "Z010", "AND A",        A &= A; _Z(A);                )
DEF_OPCODE(, A8, 1, 4,  "Z000", "XOR B",        A ^= B; _Z(A);                )
DEF_OPCODE(, A9, 1, 4,  "Z000", "XOR C",        A ^= C; _Z(A);                )
DEF_OPCODE(, AA, 1, 4,  "Z000", "XOR D",        A ^= D; _Z(A);                )
DEF_OPCODE(, AB, 1, 4,  "Z000", "XOR E",        A ^= E; _Z(A);                )
DEF_OPCODE(, AC, 1, 4,  "Z000", "XOR H",        A ^= H; _Z(A);                )
DEF_OPCODE(, AD, 1, 4,  "Z000", "XOR L",        A ^= L; _Z(A);                )
DEF_OPCODE(, AE, 1, 8,  "Z000", "XOR (HL)",     r(HL, &t8); A ^= t8; _Z(A);   )
DEF_OPCODE(, AF, 1, 4,  "Z000", "XOR A",        A ^= A; _Z(A);                )

DEF_OPCODE(, B0, 1, 4,  "Z000", "OR B",         A |= B; _Z(A);                     )
DEF_OPCODE(, B1, 1, 4,  "Z000", "OR C",         A |= C; _Z(A);                     )
DEF_OPCODE(, B2, 1, 4,  "Z000", "OR D",         A |= D; _Z(A);                     )
DEF_OPCODE(, B3, 1, 4,  "Z000", "OR E",         A |= E; _Z(A);                     )
DEF_OPCODE(, B4, 1, 4,  "Z000", "OR H",         A |= H; _Z(A);                     )
DEF_OPCODE(, B5, 1, 4,  "Z000", "OR L",         A |= L; _Z(A);                     )
DEF_OPCODE(, B6, 1, 8,  "Z000", "OR (HL)",      r(HL, &t8); A |= t8; _Z(A);        )
DEF_OPCODE(, B7, 1, 4,  "Z000", "OR A",         A |= A; _Z(A);                     )
DEF_OPCODE(, B8, 1, 4,  "Z1HC", "CP B",         _ZC15H11(A, A - B);                )
DEF_OPCODE(, B9, 1, 4,  "Z1HC", "CP C",         _ZC15H11(A, A - C);                )
DEF_OPCODE(, BA, 1, 4,  "Z1HC", "CP D",         _ZC15H11(A, A - D);                )
DEF_OPCODE(, BB, 1, 4,  "Z1HC", "CP E",         _ZC15H11(A, A - E);                )
DEF_OPCODE(, BC, 1, 4,  "Z1HC", "CP H",         _ZC15H11(A, A - H);                )
DEF_OPCODE(, BD, 1, 4,  "Z1HC", "CP L",         _ZC15H11(A, A - L);                )
DEF_OPCODE(, BE, 1, 8,  "Z1HC", "CP (HL)",      r(HL, &t8); _ZC15H11(A, A - t8);   )
DEF_OPCODE(, BF, 1, 4,  "Z1HC", "CP A",         _ZC15H11(A, A - A);                )

#define _POP(nn) r(SP, &nn ## l); r(SP+1, &nn ## h); SP += 2;
#define _PUSH(nn) w(SP-1, nn ## h); w(SP-2, nn ## l); SP -= 2;
#define _CALL(addr) _PUSH(PC); PC = addr;

DEF_OPCODE(, C0, 1, 8,  "____", "RET NZ",       _NIF(_fZ, _POP(PC), 12);           )
DEF_OPCODE(, C1, 1, 12, "____", "POP BC",       _POP(BC);                          )
DEF_OPCODE(, C2, 3, 12, "____", "JP NZ, a16",   _NIF(_fZ, PC = a16;, 4);           )
DEF_OPCODE(, C3, 3, 16, "____", "JP a16",       PC = a16;                          )
DEF_OPCODE(, C4, 3, 12, "____", "CALL NZ, a16", _NIF(_fZ, _CALL(a16), 12);         )
DEF_OPCODE(, C5, 1, 16, "____", "PUSH BC",      _PUSH(BC);                         )
DEF_OPCODE(, C6, 2, 8,  "Z0HC", "ADD A, d8",    _ADD(d8);                          )
DEF_OPCODE(, C7, 1, 16, "____", "RST 00",       _CALL(0x00);                       )
DEF_OPCODE(, C8, 1, 8,  "____", "RET Z",        _IF(_fZ, _POP(PC), 12);            )
DEF_OPCODE(, C9, 1, 16, "____", "RET",          _POP(PC);                          )
DEF_OPCODE(, CA, 3, 12, "____", "JP Z, a16",    _IF(_fZ, PC = a16, 4);             )
// DEF_OPCODE(, CB) 0xCB prefix -- see table below
DEF_OPCODE(, CC, 3, 12, "____", "CALL Z, a16",  _IF(_fZ, _CALL(a16), 12);          )
DEF_OPCODE(, CD, 3, 24, "____", "CALL a16",     _CALL(a16);                        )
DEF_OPCODE(, CE, 2, 8,  "Z0HC", "ADC A, d8",    _ADC(d8);                          )
DEF_OPCODE(, CF, 1, 16, "____", "RST 08",       _CALL(0x08);                       )

DEF_OPCODE(, D0, 1, 8,  "____", "RET NC",       _NIF(_fC, _POP(PC), 12);           )
DEF_OPCODE(, D1, 1, 12, "____", "POP DE",       _POP(DE);                          )
DEF_OPCODE(, D2, 3, 12, "____", "JP NC, a16",   _NIF(_fC, PC = a16, 4);            )
// DEF_OPCODE(, D3) invalid
DEF_OPCODE(, D4, 3, 12, "____", "CALL NC, a16", _NIF(_fC, _CALL(a16), 12);         )
DEF_OPCODE(, D5, 1, 16, "____", "PUSH DE",      _PUSH(DE);                         )
DEF_OPCODE(, D6, 2, 8,  "Z1HC", "SUB d8",       _SUB(d8);                          )
DEF_OPCODE(, D7, 1, 16, "____", "RST 10",       _CALL(0x10);                       )
DEF_OPCODE(, D8, 1, 8,  "____", "RET C",        _IF(C, _POP(PC), 12);              )
DEF_OPCODE(, D9, 1, 16, "____", "RETI",         _POP(PC); IMR = 1;                 )
DEF_OPCODE(, DA, 3, 12, "____", "JP C, a16",    _IF(C, PC = a16, 4);               )
// DEF_OPCODE(, DB) invalid
DEF_OPCODE(, DC, 3, 12, "____", "CALL C, a16",  _IF(C, _CALL(a16), 12);            )
// DEF_OPCODE(, DD) invalid
DEF_OPCODE(, DE, 2, 8,  "Z1HC", "SBC A, d8",    _SBC(d8);                          )
DEF_OPCODE(, DF, 1, 16, "____", "RST 18",       _CALL(0x18);                       )

DEF_OPCODE(, E0, 2, 12, "____", "LDH (a8), A",  w(0xFF00 + a8, A);                 )
DEF_OPCODE(, E1, 1, 12, "____", "POP HL",       _POP(HL);                          )
DEF_OPCODE(, E2, 2, 8,  "____", "LD (C), A",    w(0xFF00 + C, A);                  )
// DEF_OPCODE(, E3) invalid
// DEF_OPCODE(, E4) invalid
DEF_OPCODE(, E5, 1, 16, "____", "PUSH HL",      _PUSH(HL);                         )
DEF_OPCODE(, E6, 2, 8,  "Z010", "AND d8",       A &= d8; _Z(A);                    )
DEF_OPCODE(, E7, 1, 16, "____", "RST 20",       _CALL(0x20);                       )
DEF_OPCODE(, E8, 2, 16, "00HC", "ADD SP, r8",   _C15H11(SP, SP += r8);             )
DEF_OPCODE(, E9, 1, 4,  "____", "JP (HL)",      PC = HL;                           )
DEF_OPCODE(, EA, 3, 16, "____", "LD (a16), A",  w(a16, A);                         )
// DEF_OPCODE(, EB) invalid
// DEF_OPCODE(, EC) invalid
// DEF_OPCODE(, ED) invalid
DEF_OPCODE(, EE, 2, 8,  "Z000", "XOR d8",       A ^= d8; _Z(A);                    )
DEF_OPCODE(, EF, 1, 16, "____", "RST 28",       _CALL(0x28);                       )

DEF_OPCODE(, F0, 2, 12, "____", "LDH A, (a8)",  r(0xFF00 + a8, &A);                )
DEF_OPCODE(, F1, 1, 12, "ZNHC", "POP AF",       _POP(AF);                          )
DEF_OPCODE(, F2, 2, 8,  "____", "LD A, (C)",    r(0xFF00 + C, &A);                 )
DEF_OPCODE(, F3, 1, 4,  "____", "DI",           IMR = 0;                           )
// DEF_OPCODE(, F4) invalid
DEF_OPCODE(, F5, 1, 16, "____", "PUSH AF",      _PUSH(AF);                         )
DEF_OPCODE(, F6, 2, 8,  "Z000", "OR d8",        A |= d8; _Z(A);                    )
DEF_OPCODE(, F7, 1, 16, "____", "RST 30",       _CALL(0x30);                       )
DEF_OPCODE(, F8, 2, 12, "00HC", "LD HL, SPr8",  _C15H11(HL, HL += (SP + r8));      )
DEF_OPCODE(, F9, 1, 8,  "____", "LD SP, HL",    SP = HL;                           )
DEF_OPCODE(, FA, 3, 16, "____", "LD A, (a16)",  r(a16, &A);                        )
DEF_OPCODE(, FB, 1, 4,  "____", "EI",           IMR = 1;                           )
// DEF_OPCODE(, FC) invalid
// DEF_OPCODE(, FD) invalid
DEF_OPCODE(, FE, 2, 8,  "Z1HC", "CP d8",        _ZC15H11(A, A - d8);               )
DEF_OPCODE(, FF, 1, 16, "____", "RST 38",       _CALL(0x38);                       )

#undef _CALL
#undef _PUSH
#undef _POP
#undef _SBC
#undef _SUB
#undef _ADC
#undef _ADD

#undef TODO
#undef DEF_OPCODE
